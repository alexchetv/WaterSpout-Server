<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>Server Monitor</title>
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
	<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
	<script type="text/javascript" src="/static/get/protoaculous.1.8.3.min.js"></script>
	<script type="text/javascript" src="/static/get/realtime.js"></script>
	<script type="text/javascript">
		new Ajax.PeriodicalUpdater('container', '/server/status', {
			frequency: 1,
			decay: 1,
			method: 'post',
			onSuccess: update_status,
			onFailure: update_status,
			onException: update_status
		});

		function update_status(evt) {
			var data = evt.responseJSON;
			if (data) {
				$('data_listeners').update(addCommas(data['listeners']));
				$('data_peakmemory').update(addCommas(data['peak_memory']) + ' bytes');
				$('data_currentmemory').update(addCommas(data['current_memory']) + ' bytes');
			} else {
				$('data_listeners').update('-');
				$('data_peakmemory').update('-');
				$('data_currentmemory').update('-');
			}
		}

		function reload_config() {
			var verbose = prompt('Please enter the verbosity level you would like.', '0');
			var realtime = new RealTimeMessage('dev.onforce.com:7777/server/reloadconfig');
			realtime.onmessage = function(data) { alert(data); };
			realtime.send({'verbose': verbose});
		}

		function restart_server() {
			if (confirm('Are you sure you would like to restart the server?')) {
				var realtime = new RealTimeMessage('dev.onforce.com:7777/server/restart');
				realtime.onmessage = function(data) { alert(data); };
				realtime.send();
			}
		}

		function shutdown_server() {
			if (confirm('Are you sure you would like to shut down the server?')) {
				var realtime = new RealTimeMessage('dev.onforce.com:7777/server/shutdown');
				realtime.onmessage = function(data) { alert(data); };
				realtime.send();
			}
		}

		function addCommas(nStr) {
			nStr += '';
			x = nStr.split('.');
			x1 = x[0];
			x2 = x.length > 1 ? '.' + x[1] : '';
			var rgx = /(\d+)(\d{3})/;
			while (rgx.test(x1)) {
				x1 = x1.replace(rgx, '$1' + ',' + '$2');
			}
			return x1 + x2;
		}
	</script>
	<style type="text/css">
		body, td, th {font-family:Arial; font-size:12px; line-height:130%;}
		input, textarea, select, button {font-family:Arial; font-size:11px; vertical-align:middle;}
		th {text-align:left;}
		.server_action {width:220px;}
	</style>
</head>
<body>
	<img src="/static/get/images/waterspout.png" border="0" alt="Waterspout" />
	<h1>Server Monitor</h1>

	<table>
	<tr>
		<th width="100">Listeners:</th>
		<td id="data_listeners">-</td>
	</tr>
	<tr>
		<th>Peak Memory:</th>
		<td id="data_peakmemory">-</td>
	</tr>
	<tr>
		<th>Current Memory:</th>
		<td id="data_currentmemory">-</td>
	</tr>
	</table>

	<p>
		<input type="button" value="Reload Config" onclick="javascript:reload_config(); return false;" class="server_action" /><br />
		<input type="button" value="Restart Server" onclick="javascript:restart_server(); return false;" class="server_action" /><br />
		<input type="button" value="Shutdown Server" onclick="javascript:shutdown_server(); return false;" class="server_action" />
	</p>
</body>
</html>
